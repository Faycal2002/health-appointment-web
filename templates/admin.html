{% extends "base.html" %}
{% block title %}Admin - SmartHealth{% endblock %}

{% block content %}
<section class="min-vh-100 align-items-center mt-5 mb-5">
  <div class="container">
    <div class="row g-4 justify-content-center">

      <div class="col-12 col-md-10 col-lg-10">
        <div class="card shadow-sm rounded-4">
          <div class="card-body p-4">
            <h4 class="mb-3">Admin Dashboard</h4>
            <p>Welcome, Admin! Manage doctors, users and appointments below.</p>

            {# ============================== #}
            {# 1️⃣ DOCTORS (TABLE + ADD)       #}
            {# ============================== #}
            <h5 class="mb-3 mt-4">Doctors</h5>
            <p>All doctors registered in the database:</p>

            <div class="table-responsive">
              <table class="table table-striped table-bordered align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Specialty</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for doctor in doctors %}
                  <tr>
                    <th>{{ doctor.id }}</th>

                    <td>
                      {% if doctor.image %}
                        <img src="{{ url_for('static', filename=doctor.image) }}" width="70" height="70" class="rounded" style="object-fit: cover;">
                      {% else %}
                        <div class="bg-secondary rounded" style="width:70px;height:70px;"></div>
                      {% endif %}
                    </td>

                    <td>{{ doctor.name }}</td>
                    <td>{{ doctor.specialty }}</td>
                    <td>{{ doctor.location }}</td>
                    <td>{{ doctor.description }}</td>

                    <td>
                      <!-- EDIT -->
                      <button class="btn btn-sm btn-outline-primary"
                              type="button"
                              data-bs-toggle="modal"
                              data-bs-target="#editDoctor{{ doctor.id }}">
                        Edit
                      </button>

                      <!-- DELETE -->
                      <form method="post"
                            action="{{ url_for('delete_doctor', doctor_id=doctor.id) }}"
                            class="d-inline">
                        <button type="submit"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Delete this doctor?');">
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- FORMULAIRE : ADD DOCTOR -->
            <form method="post" 
                  action="{{ url_for('add_doctor') }}"
                  enctype="multipart/form-data"
                  class="mt-4">

              <div class="row g-2">

                <div class="col-md-3">
                  <input type="text" name="name" class="form-control" placeholder="Name" required>
                </div>

                <div class="col-md-3">
                  <input type="text" name="specialty" class="form-control" placeholder="Specialty" required>
                </div>

                <div class="col-md-3">
                  <input type="text" name="location" class="form-control" placeholder="Location" required>
                </div>

                <div class="col-md-3">
                  <input type="file" name="image" class="form-control" accept="image/*" required>
                </div>

              </div>

              <div class="row mt-2">
                <div class="col-12">
                  <input type="text" name="description" class="form-control" placeholder="Description">
                </div>
              </div>

              <div class="d-grid mt-3 mb-5">
                <button type="submit" class="btn btn-dark rounded-pill">Add Doctor</button>
              </div>

            </form>


            {# ============================== #}
            {# 2️⃣ USERS (TABLE + ADD)        #}
            {# ============================== #}
            <h5 class="mb-3 mt-4">Registered Users</h5>
            <p>All users who registered on SmartHealth:</p>

            <div class="table-responsive">
              <table class="table table-striped table-bordered align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Address</th>
                    <th>Phone Number</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %}
                  <tr>
                    <th>{{ user.id }}</th>
                    <td>{{ user.firstname }}</td>
                    <td>{{ user.lastname }}</td>
                    <td>{{ user.address }}</td>
                    <td>{{ user.number }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary"
                              type="button"
                              data-bs-toggle="modal"
                              data-bs-target="#editUser{{ user.id }}">
                        Edit
                      </button>

                      <form method="post"
                            action="{{ url_for('delete_user', user_id=user.id) }}"
                            class="d-inline">
                        <button type="submit"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Delete this user?');">
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- FORMULAIRE : ADD USER -->
            <form method="post" action="{{ url_for('add_user') }}" class="mt-4">
              <div class="row g-2">
                <div class="col-md-3">
                  <input type="text" name="firstname" class="form-control" placeholder="First name" required>
                </div>
                <div class="col-md-3">
                  <input type="text" name="lastname" class="form-control" placeholder="Last name" required>
                </div>
                <div class="col-md-3">
                  <input type="text" name="address" class="form-control" placeholder="Address" required>
                </div>
                <div class="col-md-3">
                  <input type="text" name="number" class="form-control" placeholder="Phone" required>
                </div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-md-4">
                  <input type="email" name="email" class="form-control" placeholder="Email" required>
                </div>
                <div class="col-md-4">
                  <input type="password" name="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="col-md-4">
                  <select name="role" class="form-select">
                    <option value="patient">Patient</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
              </div>

              <div class="d-grid mt-3 mb-5">
                <button type="submit" class="btn btn-dark rounded-pill">Add User</button>
              </div>
            </form>


            {# ============================== #}
            {# 3️⃣ APPOINTMENTS (TABLE + ADD) #}
            {# ============================== #}
            <h5 class="mb-3 mt-4">Appointments</h5>
            <p>All appointments booked on SmartHealth:</p>

            <div class="table-responsive">
              <table class="table table-striped table-bordered align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Patient Name</th>
                    <th>Doctor</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Symptoms</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for appt in appointments %}
                  <tr>
                    <th>{{ appt.id }}</th>
                    <td>{{ appt.patient_name }}</td>
                    <td>{{ appt.doctor.name }}</td>
                    <td>{{ appt.date }}</td>
                    <td>{{ appt.hour }}</td>
                    <td>{{ appt.symptoms }}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary"
                              type="button"
                              data-bs-toggle="modal"
                              data-bs-target="#editAppt{{ appt.id }}">
                        Edit
                      </button>

                      <form method="post"
                            action="{{ url_for('delete_appointment', appt_id=appt.id) }}"
                            class="d-inline">
                        <button type="submit"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Delete this appointment?');">
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- FORMULAIRE : ADD APPOINTMENT -->
            <form method="post" action="{{ url_for('add_appointment') }}" class="mt-4">
              <div class="row g-2">
                <div class="col-md-3">
                  <input type="text" name="patient_name" class="form-control" placeholder="Patient name" required>
                </div>
                <div class="col-md-3">
                  <select name="doctor_id" class="form-select" required>
                    <option value="" disabled selected>Choose doctor</option>
                    {% for doctor in doctors %}
                      <option value="{{ doctor.id }}">{{ doctor.name }} ({{ doctor.specialty }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <input type="date" name="date" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <input type="time" name="hour" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <input type="text" name="symptoms" class="form-control" placeholder="Symptoms" required>
                </div>
              </div>

              <div class="d-grid mt-3 mb-3">
                <button type="submit" class="btn btn-dark rounded-pill">Add Appointment</button>
              </div>
            </form>

          </div> <!-- card-body -->
        </div> <!-- card -->
      </div> <!-- col -->

    </div> <!-- row -->
  </div> <!-- container -->
</section>


{# ========================================== #}
{# MODALS EDIT DOCTORS                       #}
{# ========================================== #}
{% for doctor in doctors %}
<div class="modal fade" id="editDoctor{{ doctor.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Doctor #{{ doctor.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" 
            action="{{ url_for('update_doctor', doctor_id=doctor.id) }}"
            enctype="multipart/form-data">

        <div class="modal-body">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" name="name" value="{{ doctor.name }}" required>

          <label class="form-label mt-2">Specialty</label>
          <input type="text" class="form-control" name="specialty" value="{{ doctor.specialty }}" required>

          <label class="form-label mt-2">Location</label>
          <input type="text" class="form-control" name="location" value="{{ doctor.location }}" required>

          <label class="form-label mt-2">Description</label>
          <textarea class="form-control" name="description">{{ doctor.description }}</textarea>

          <label class="form-label mt-3">Change Photo</label>
          <input type="file" class="form-control" name="image" accept="image/*">

          {% if doctor.image %}
          <img src="{{ url_for('static', filename=doctor.image) }}"
               class="img-fluid rounded mt-2"
               width="120">
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>

      </form>

    </div>
  </div>
</div>
{% endfor %}


{# ========================================== #}
{# MODALS EDIT USERS                         #}
{# ========================================== #}
{% for user in users %}
<div class="modal fade" id="editUser{{ user.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit User #{{ user.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{{ url_for('update_user', user_id=user.id) }}">
        <div class="modal-body">

          <label class="form-label">First name</label>
          <input type="text" class="form-control" name="firstname" value="{{ user.firstname }}" required>

          <label class="form-label mt-2">Last name</label>
          <input type="text" class="form-control" name="lastname" value="{{ user.lastname }}" required>

          <label class="form-label mt-2">Address</label>
          <input type="text" class="form-control" name="address" value="{{ user.address }}" required>

          <label class="form-label mt-2">Phone</label>
          <input type="text" class="form-control" name="number" value="{{ user.number }}" required>

          <label class="form-label mt-2">Email</label>
          <input type="email" class="form-control" name="email" value="{{ user.email }}" required>

          <label class="form-label mt-2">Role</label>
          <select name="role" class="form-select">
            <option value="patient" {% if user.role == 'patient' %}selected{% endif %}>Patient</option>
            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
          </select>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>

      </form>

    </div>
  </div>
</div>
{% endfor %}


{# ========================================== #}
{# MODALS EDIT APPOINTMENTS                  #}
{# ========================================== #}
{% for appt in appointments %}
<div class="modal fade" id="editAppt{{ appt.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Appointment #{{ appt.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{{ url_for('update_appointment', appt_id=appt.id) }}">
        <div class="modal-body">

          <label class="form-label">Patient name</label>
          <input type="text" class="form-control" name="patient_name" value="{{ appt.patient_name }}" required>

          <label class="form-label mt-2">Doctor</label>
          <select name="doctor_id" class="form-select">
            {% for doctor in doctors %}
              <option value="{{ doctor.id }}"
                      {% if doctor.id == appt.doctor_id %}selected{% endif %}>
                {{ doctor.name }} ({{ doctor.specialty }})
              </option>
            {% endfor %}
          </select>

          <label class="form-label mt-2">Date</label>
          <input type="date" class="form-control" name="date" value="{{ appt.date }}" required>

          <label class="form-label mt-2">Time</label>
          <input type="time" class="form-control" name="hour" value="{{ appt.hour }}" required>

          <label class="form-label mt-2">Symptoms</label>
          <input type="text" class="form-control" name="symptoms" value="{{ appt.symptoms }}" required>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>

      </form>

    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
